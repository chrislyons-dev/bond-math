openapi: 3.0.3
info:
  title: Day-Count Service API
  version: "2025.10"
  description: |
    Authoritative day-count and year-fraction calculations for Bond Math.

    Provides deterministic, versioned calculations for all major day-count conventions
    used in fixed-income markets. Serves as the single source of truth for accrual
    calculations across all Bond Math services.
  contact:
    name: Chris Lyons
    url: https://bondmath.chrislyons.dev
  license:
    name: MIT

servers:
  - url: https://api.bondmath.chrislyons.dev/api/daycount/v1
    description: Production (via Gateway)
  - url: http://localhost:8787
    description: Local development

tags:
  - name: calculations
    description: Day-count and year-fraction calculations
  - name: health
    description: Service health checks

paths:
  /count:
    post:
      tags:
        - calculations
      summary: Calculate year fractions for date pairs
      description: |
        Calculates day counts and year fractions for one or more date pairs using
        the specified day-count convention.

        Supports up to 1000 date pairs per request.
      operationId: calculateDayCount
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DayCountRequest'
            examples:
              act360:
                summary: ACT/360 calculation
                value:
                  pairs:
                    - start: "2025-01-31"
                      end: "2025-07-31"
                  convention: "ACT_360"
              thirty360WithOptions:
                summary: 30/360 with EOM rule
                value:
                  pairs:
                    - start: "2025-01-31"
                      end: "2025-07-31"
                  convention: "30_360"
                  options:
                    eomRule: true
              actActIcma:
                summary: ACT/ACT ICMA with frequency
                value:
                  pairs:
                    - start: "2025-01-01"
                      end: "2025-07-01"
                  convention: "ACT_ACT_ICMA"
                  options:
                    frequency: 2
              multiplePairs:
                summary: Multiple date pairs
                value:
                  pairs:
                    - start: "2025-01-01"
                      end: "2025-06-30"
                    - start: "2025-07-01"
                      end: "2025-12-31"
                  convention: "ACT_365F"
      responses:
        '200':
          description: Successful calculation
          headers:
            Cache-Control:
              schema:
                type: string
                example: "public, max-age=3600"
              description: Response is cacheable for 1 hour
            X-Service-Version:
              schema:
                type: string
                example: "2025.10"
              description: Service version
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DayCountResponse'
              examples:
                singleResult:
                  summary: Single date pair result
                  value:
                    results:
                      - days: 181
                        yearFraction: 0.5027777777777778
                        basis: 360
                    convention: "ACT_360"
                    version: "2025.10"
                multipleResults:
                  summary: Multiple date pairs result
                  value:
                    results:
                      - days: 181
                        yearFraction: 0.4958904109589041
                        basis: 365
                      - days: 184
                        yearFraction: 0.5041095890410959
                        basis: 365
                    convention: "ACT_365F"
                    version: "2025.10"
        '400':
          description: Validation error or calculation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                invalidConvention:
                  summary: Invalid convention
                  value:
                    type: "https://bondmath.chrislyons.dev/errors/invalid-convention"
                    title: "Invalid Convention"
                    status: 400
                    detail: "Unsupported convention: INVALID"
                    errors:
                      - field: "convention"
                        message: "Unsupported convention: INVALID"
                invalidDateFormat:
                  summary: Invalid date format
                  value:
                    type: "https://bondmath.chrislyons.dev/errors/calculation-error"
                    title: "Calculation Error"
                    status: 400
                    detail: "One or more date pairs could not be calculated"
                    errors:
                      - field: "pairs[0].start"
                        message: "Invalid date format: 2025/01/01. Expected YYYY-MM-DD"
                tooManyPairs:
                  summary: DoS prevention
                  value:
                    type: "https://bondmath.chrislyons.dev/errors/validation-error"
                    title: "Validation Error"
                    status: 400
                    detail: "Maximum 1000 pairs per request"
                    errors:
                      - field: "pairs"
                        message: "Maximum 1000 pairs per request"

  /health:
    get:
      tags:
        - health
      summary: Health check
      description: Returns service health status and version information
      operationId: healthCheck
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'
              example:
                status: "healthy"
                service: "daycount"
                version: "2025.10"

components:
  schemas:
    DayCountRequest:
      type: object
      required:
        - pairs
        - convention
      properties:
        pairs:
          type: array
          description: Date pairs to calculate (max 1000)
          minItems: 1
          maxItems: 1000
          items:
            $ref: '#/components/schemas/DatePair'
        convention:
          $ref: '#/components/schemas/DayCountConvention'
        options:
          $ref: '#/components/schemas/DayCountOptions'

    DatePair:
      type: object
      required:
        - start
        - end
      properties:
        start:
          type: string
          format: date
          pattern: '^\d{4}-\d{2}-\d{2}$'
          description: Start date in ISO 8601 format (YYYY-MM-DD)
          example: "2025-01-31"
        end:
          type: string
          format: date
          pattern: '^\d{4}-\d{2}-\d{2}$'
          description: End date in ISO 8601 format (YYYY-MM-DD)
          example: "2025-07-31"

    DayCountConvention:
      type: string
      description: Day-count convention to use for calculation
      enum:
        - ACT_360
        - ACT_365F
        - 30_360
        - 30E_360
        - ACT_ACT_ISDA
        - ACT_ACT_ICMA
      example: "ACT_360"

    DayCountOptions:
      type: object
      description: Optional parameters for specific conventions
      properties:
        eomRule:
          type: boolean
          description: End-of-month rule for 30/360 conventions
          example: true
        frequency:
          type: integer
          minimum: 1
          description: Coupon frequency per year (required for ACT/ACT ICMA)
          example: 2

    DayCountResponse:
      type: object
      required:
        - results
        - convention
        - version
      properties:
        results:
          type: array
          description: Calculation results for each date pair
          items:
            $ref: '#/components/schemas/DayCountResult'
        convention:
          $ref: '#/components/schemas/DayCountConvention'
        version:
          type: string
          description: Service version
          example: "2025.10"

    DayCountResult:
      type: object
      required:
        - days
        - yearFraction
        - basis
      properties:
        days:
          type: integer
          description: Number of days between start and end
          example: 181
        yearFraction:
          type: number
          format: double
          description: Year fraction calculated using the specified convention
          example: 0.5027777777777778
        basis:
          type: integer
          description: Denominator used in calculation (360, 365, or varies)
          example: 360

    HealthResponse:
      type: object
      required:
        - status
        - service
        - version
      properties:
        status:
          type: string
          enum:
            - healthy
          example: "healthy"
        service:
          type: string
          example: "daycount"
        version:
          type: string
          example: "2025.10"

    ErrorResponse:
      type: object
      required:
        - type
        - title
        - status
        - detail
      properties:
        type:
          type: string
          format: uri
          description: URI reference identifying the problem type (RFC 7807)
          example: "https://bondmath.chrislyons.dev/errors/validation-error"
        title:
          type: string
          description: Short, human-readable summary of the problem
          example: "Validation Error"
        status:
          type: integer
          description: HTTP status code
          example: 400
        detail:
          type: string
          description: Human-readable explanation of the problem
          example: "One or more date pairs could not be calculated"
        errors:
          type: array
          description: Field-level validation errors
          items:
            $ref: '#/components/schemas/ValidationError'

    ValidationError:
      type: object
      required:
        - field
        - message
      properties:
        field:
          type: string
          description: Field path that caused the error
          example: "pairs[0].start"
        message:
          type: string
          description: Detailed error message
          example: "Invalid date format: 2025/01/01. Expected YYYY-MM-DD"
