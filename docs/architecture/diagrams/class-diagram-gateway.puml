@startuml
title Gateway - Class Diagram

skinparam classAttributeIconSize 0
skinparam linetype ortho

interface ActorClaim {
  iss: string
  sub: string
  role?: string
  perms: string[]
  org?: string
  uid?: string
}
note right of ActorClaim
  
Actor claim - represents "Service X acting for User Y"
end note

interface Auth0Claims {
  iss: string
  sub: string
  aud: string | string[]
  exp: number
  iat: number
  scope?: string
  permissions?: string[]
  'https://bondmath.chrislyons.dev/role'?: string
  'https://bondmath.chrislyons.dev/permissions'?: string[]
  'https://bondmath.chrislyons.dev/user_id'?: string
  'https://bondmath.chrislyons.dev/org_id'?: string
}
note right of Auth0Claims
  
Auth0 JWT claims (after verification)
end note

interface Env {
  AUTH0_DOMAIN: string
  AUTH0_AUDIENCE: string
  INTERNAL_JWT_SECRET: string
  INTERNAL_JWT_TTL: string
  ENVIRONMENT?: string
  SVC_DAYCOUNT: Fetcher
  SVC_VALUATION: Fetcher
  SVC_METRICS: Fetcher
  SVC_PRICING: Fetcher
}
note right of Env
  
Type definitions for Gateway Worker
end note

interface ErrorResponse {
  type: string
  title: string
  status: number
  detail: string
  instance?: string
}
note right of ErrorResponse
  
RFC 7807 Problem Details error response
end note

interface InternalJWT {
  iss: string
  sub: string
  aud: string
  exp: number
  rid: string
  act: ActorClaim
}
note right of InternalJWT
  
Internal JWT payload structure
end note

interface JWK {
  kty: string
  use: string
  kid: string
  n: string
  e: string
  alg?: string
  x5c?: string[]
  x5t?: string
}
note right of JWK
  
JSON Web Key structure
end note

interface JWKS {
  keys: JWK[]
}
note right of JWKS
  
Auth0 JWKS response structure
end note

interface ServiceRoute {
  prefix: string
  binding: keyof Env
  stripPrefix: boolean
}
note right of ServiceRoute
  
Service route mapping
end note

interface Variables {
  requestId: string
  userId?: string
}
note right of Variables
  
Hono context variables
end note

' Relationships
InternalJWT ..> ActorClaim : uses
JWKS ..> JWK : uses

@enduml